<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:utext="${application_name}"></title>
    <link type="text/css" rel="stylesheet" th:href="@{/libs/webix.min.css}">
    <script th:src="@{/libs/webix.min.js}"></script>
    <script th:src="@{/libs/routie.min.js}"></script>
    <script th:src="@{/libs/jquery-3.4.1.min.js}"></script>
    <style>
        body {margin: 0}
        .boldLabel {
            font-weight: bold; border-width: 2px; border-style: solid; border-color: #000000;
        }
    </style>
</head>
<body>
<div id="app"></div>
<script th:inline="javascript">
    const APPLICATION_NAME = [[${application_name}]];
    const EGRUL_ADDRESS = [[${egrul_address}]]

    webix.i18n.setLocale("ru-RU");

    let regLayout = webix.ui({
        container: 'app',
        height: document.body.clientHeight,
        minWidth: 280,
        width: 768,
        css: {margin: 'auto'},
        rows: [
            {
                view: 'toolbar',
                autoheight: true,
                id: 't1',
                rows: [
                    {
                        responsive: 't1',
                        css: 'webix_dark',
                        cols: [
                            {},
                            {
                                view: 'label',
                                width: 300,
                                align: 'center',
                                label: `<span style="font-size: 1.3rem">Регистрация</span>`,
                            },
                            {}
                        ]
                    }
                ]
            },
            {
                id: 'form',
                view: 'form',
                complexData: true,
                elements: [
                    {
                        id: "egrulBtnIn",
                        rows:[]
                    },
                    {
                        id: 'egrul_search',
                        responsive: "egrulBtnIn",
                        cols: [
                            {
                                view: 'button',
                                id: 'egrul_load_button',
                                css: 'webix_primary',
                                minWidth: 250,
                                value: 'Заполнить по ИНН',
                                align: 'center',
                                click: function () {
                                    const inn = $$('searchInn').getValue();
                                    if (inn === '') {
                                        $$('searchInn').focus();
                                        webix.message('ИНН не введен', 'error');
                                        return;
                                    } else if (isNaN(inn)) {
                                        $$('searchInn').focus();
                                        webix.message('ИНН не соответствует формату', 'error');
                                        return;
                                    }
                                    let type = '';
                                    if (inn.length === 10) {
                                        type = 'egrul';
                                    } else if (inn.length === 12) {
                                        type = 'egrip';
                                    }
                                    if (type === '') {
                                        $$('searchInn').focus();
                                        webix.message('ИНН не соответствует формату', 'error');
                                        return;
                                    }

                                    $$('form').showProgress();

                                    setTimeout(function () {
                                        webix.ajax(EGRUL_ADDRESS + '/' + type + '?inn=' + inn).then(function (data) {
                                            const response = data.json();
                                            if (!response.data) {
                                                webix.message('Данные не найдены', 'error');
                                                $$('form').hideProgress();
                                                return;
                                            }
                                            if (type === 'egrul') {
                                                const result = response.data;
                                                let egrulOkvedAdd = [];
                                                let okvedAdd = '';
                                                if (result.свОКВЭД.свОКВЭДДоп) {
                                                    result.свОКВЭД.свОКВЭДДоп.forEach(function (elem) {
                                                        okvedAdd += elem.кодОКВЭД + ' ' + elem.наимОКВЭД + '\n';
                                                        egrulOkvedAdd.push(elem.кодОКВЭД);
                                                    })
                                                }
                                                let jurAddress = '';
                                                if (result.свАдресЮЛ) {
                                                    jurAddress += result.свАдресЮЛ.адресРФ.индекс
                                                    jurAddress += ', ' + result.свАдресЮЛ.адресРФ.регион.наимРегион;
                                                    jurAddress += result.свАдресЮЛ.адресРФ.район.наимРайон ? ', ' + result.свАдресЮЛ.адресРФ.район.наимРайон : '';
                                                    jurAddress += result.свАдресЮЛ.адресРФ.город.наимГород ? ', ' + result.свАдресЮЛ.адресРФ.город.наимГород : '';
                                                    jurAddress += result.свАдресЮЛ.адресРФ.населПункт.наимНаселПункт ? ', ' + result.свАдресЮЛ.адресРФ.населПункт.наимНаселПункт : '';
                                                    jurAddress += result.свАдресЮЛ.адресРФ.улица.наимУлица ? ', ' + result.свАдресЮЛ.адресРФ.улица.наимУлица : '';
                                                    jurAddress += result.свАдресЮЛ.адресРФ.дом ? ', ' + result.свАдресЮЛ.адресРФ.дом : '';
                                                    jurAddress += result.свАдресЮЛ.адресРФ.корпус ? ', ' + result.свАдресЮЛ.адресРФ.корпус : '';
                                                    jurAddress += result.свАдресЮЛ.адресРФ.квартира ? ', ' + result.свАдресЮЛ.адресРФ.квартира : '';
                                                }
                                                $$('form').setValues({
                                                    searchInn: inn,
                                                    organizationName: result.свНаимЮЛ.наимЮЛПолн,
                                                    organizationShortName: result.свНаимЮЛ.наимЮЛСокр,
                                                    organizationInn: result.инн,
                                                    organizationOgrn: result.огрн,
                                                    organizationEmail: result.свАдрЭлПочты.email,
                                                    organizationOkved: result.свОКВЭД.свОКВЭДОсн.кодОКВЭД + ' ' + result.свОКВЭД.свОКВЭДОсн.наимОКВЭД,
                                                    egrulOkved: result.свОКВЭД.свОКВЭДОсн.кодОКВЭД,
                                                    organizationOkvedAdd: okvedAdd,
                                                    egrulOkvedAdd: egrulOkvedAdd,
                                                    organizationAddressJur: jurAddress
                                                })
                                            } else {
                                                const result = response.data;
                                                let name = result.наимВидИП;
                                                name += result.свФЛ.фиорус.фамилия ? ' ' + result.свФЛ.фиорус.фамилия : '';
                                                name += result.свФЛ.фиорус.имя ? ' ' + result.свФЛ.фиорус.имя : '';
                                                name += result.свФЛ.фиорус.отчество ? ' ' + result.свФЛ.фиорус.отчество : '';
                                                let egrulOkvedAdd = [];
                                                let okvedAdd = '';
                                                if (result.свОКВЭД.свОКВЭДДоп) {
                                                    result.свОКВЭД.свОКВЭДДоп.forEach(function (elem) {
                                                        okvedAdd += elem.кодОКВЭД + ' ' + elem.наимОКВЭД + '\n';
                                                        egrulOkvedAdd.push(elem.кодОКВЭД);
                                                    })
                                                }
                                                let jurAddress = '';
                                                if (result.свАдрМЖ) {
                                                    jurAddress += result.свАдрМЖ.адресРФ.регион.наимРегион;
                                                    jurAddress += result.свАдрМЖ.адресРФ.район.наимРайон ? ', ' + result.свАдрМЖ.адресРФ.район.наимРайон : '';
                                                    jurAddress += result.свАдрМЖ.адресРФ.город.наимГород ? ', ' + result.свАдрМЖ.адресРФ.город.наимГород : '';
                                                    jurAddress += result.свАдрМЖ.адресРФ.населПункт.наимНаселПункт ? ', ' + result.свАдрМЖ.адресРФ.населПункт.наимНаселПункт : '';
                                                }
                                                $$('form').setValues({
                                                    searchInn: inn,
                                                    organizationName: name,
                                                    organizationShortName: name,
                                                    organizationInn: result.иннфл,
                                                    organizationOgrn: result.огрнип,
                                                    organizationEmail: result.свАдрЭлПочты.email,
                                                    organizationOkved: result.свОКВЭД.свОКВЭДОсн.кодОКВЭД + ' ' + result.свОКВЭД.свОКВЭДОсн.наимОКВЭД,
                                                    egrulOkved: result.свОКВЭД.свОКВЭДОсн.кодОКВЭД,
                                                    organizationOkvedAdd: okvedAdd,
                                                    egrulOkvedAdd: egrulOkvedAdd,
                                                    organizationAddressJur: jurAddress
                                                })
                                            }
                                            $$('form').hideProgress();
                                        }).catch(function () {
                                            webix.message('Не удалось получить данные', 'error');
                                            $$('form').hideProgress();
                                        });
                                    }, 500);
                                }
                            },
                            {
                                view: 'text',
                                name: 'searchInn',
                                id: 'searchInn',
                                minWidth: 250,
                                // label: 'ИНН',
                                placeholder: 'ИНН',
                            },
                        ],
                        hidden: true
                    },
                    {
                        type: 'space',
                        margin: 5,
                        rows: [
                            {
                                view: 'text',
                                id: 'organizationName',
                                name: 'organizationName',
                                label: 'Полное наименование организации/фамилия, имя, отчество индивидуального предпринимателя',
                                labelPosition: 'top',
                                required: true
                            },
                            {
                                view: 'text',
                                id: 'organizationShortName',
                                name: 'organizationShortName',
                                label: 'Краткое наименование организации',
                                labelPosition: 'top',
                                required: true
                            },
                            {

                                id: 'spaceRows',
                                rows:[]
                            },
                            {
                                responsive: "spaceRows",
                                cols: [
                                    {
                                        view: 'text',
                                        id: 'organizationInn',
                                        name: 'organizationInn',
                                        minWidth: 250,
                                        label: 'ИНН',
                                        labelPosition: 'top',
                                        validate: webix.rules.isNumber,
                                        required: true,
                                    },
                                    {
                                        view: 'checkbox',
                                        name: 'isSelfEmployed',
                                        labelPosition: 'top',
                                        minWidth: 90,
                                        label: 'Самозанятый',
                                        on: {
                                            onChange(newv, oldv) {
                                                if (newv === 1) {
                                                    $$('organizationOgrn').setValue('');
                                                    $$('organizationOgrn').disable();
                                                } else {
                                                    $$('organizationOgrn').enable();
                                                }
                                            }
                                        }
                                    }
                                ]
                            },
                            {
                                view: 'text',
                                id: 'organizationOgrn',
                                name: 'organizationOgrn',
                                label: 'ОГРН',
                                validate: webix.rules.isNumber,
                                labelPosition: 'top',
                                required: true
                            },
                            {
                                view: 'text',
                                id: 'organizationOkved',
                                name: 'organizationOkved',
                                label: 'Основной вид осуществляемой деятельности (отрасль)',
                                labelPosition: 'top',
                                placeholder: '01.11',
                                required: true,
                                on: {
                                    onKeyPress(code, event) {
                                        if (code === 32) {
                                            return false;
                                        }
                                    }
                                }
                            },
                            {
                                view: 'textarea',
                                id: 'organizationOkvedAdd',
                                name: 'organizationOkvedAdd',
                                label: 'Дополнительные виды осуществляемой деятельности',
                                height: 100,
                                labelPosition: 'top',
                                placeholder: '01.13\n01.13.1',
                                on: {
                                    onKeyPress(code, event) {
                                        if (code === 32) {
                                            this.setValue(this.getValue() + '\n')
                                            return false;
                                        }
                                    }
                                }
                            },
                            {
                                view: 'textarea',
                                id: 'organizationAddressJur',
                                name: 'organizationAddressJur',
                                label: 'Юридический адрес',
                                labelPosition: 'top',
                                height: 80,
                                required: true
                            },
                            {
                                view: 'text',
                                id: 'organizationEmail',
                                name: 'organizationEmail',
                                label: 'Адрес электронной почты',
                                labelPosition: 'top',
                                validate: webix.rules.isEmail,
                                required: true
                            },
                            {
                                view: 'text',
                                name: 'organizationPhone',
                                label: 'Телефон',
                                labelPosition: 'top',
                                required: true
                            },
                            {
                                view: 'text',
                                id: 'password',
                                name: 'password',
                                type: 'password',
                                label: 'Пароль',
                                labelPosition: 'top',
                                required: true,
                                attributes: { autocomplete: 'new-password' }
                            }
                        ]
                    },
                    {
                        id: 'send_btn',
                        view: 'button',
                        css: 'webix_primary',
                        value: 'Зарегистрироваться',
                        align: 'center',
                        click: function () {
                            this.disable();
                            console.log($$('form').getValues());

                            if ($$('form').validate()) {

                                let params = $$('form').getValues();

                                if (params.organizationShortName.length > 255) {
                                    webix.message('Превышена длина краткого наименования', 'error')
                                    return false
                                }

                                params.organizationInn = params.organizationInn.trim();
                                params.organizationOgrn = params.organizationOgrn.trim();

                                if (params.organizationInn.length > 12) {
                                    webix.message('Превышена длина ИНН', 'error');
                                    return false;
                                }

                                if (params.organizationOgrn.length > 15) {
                                    webix.message('Превышена длина ОГРН', 'error');
                                    return false;
                                }

                                if (params.organizationAddressJur.length > 255) {
                                    webix.message('Превышена длина юридического адреса', 'error')
                                    return false
                                }

                                if (params.organizationEmail.length > 100) {
                                    webix.message('Превышена длина электронной почты', 'error');
                                    return false;
                                } else {
                                    let bad_val = params.organizationEmail.indexOf("*") > -1
                                        || params.organizationEmail.indexOf("+") > -1
                                        || params.organizationEmail.indexOf('"') > -1;
                                    if (bad_val == true) {
                                        webix.message('Недопустимые символы в адресе электронной почты', 'error');
                                        return false;
                                    }
                                }

                                if (params.organizationPhone.length > 100) {
                                    webix.message('Превышена длина номера телефона', 'error');
                                    return false;
                                }

                                webix.ajax()
                                    .headers({'Content-type': 'application/json'})
                                    .post('/registration', JSON.stringify(params)
                                    ).then(function (data) {
                                        const text = data.text();
                                        if (text === 'Ок') {
                                            window.location='/login';
                                        } else {
                                            webix.message(text, 'error')
                                        }
                                    })
                            } else {
                                webix.message('Не заполнены обязательные поля', 'error')
                            }

                            this.enable();
                        }
                    }
                ]
            }
        ]
    })

    webix.ready(function() {
        if (EGRUL_ADDRESS) {
            webix.extend($$('form'), webix.ProgressBar);
            $$('egrul_search').show();
        }

        if (document.body.clientWidth < 480){
            regLayout.config.width = document.body.clientWidth; regLayout.resize();
            $$("organizationName").config.label = "Наим. орг./ФИО ИП"; $$("organizationName").refresh();
            $$("organizationShortName").config.label = "Краткое наим. огр."; $$("organizationShortName").refresh();
            $$("organizationOkved").config.label = "Осн. вид деятельности"; $$("organizationOkved").refresh();
            $$("organizationOkvedAdd").config.label = "Доп. виды деятельности"; $$("organizationOkvedAdd").refresh();

        }
    })
</script>
</body>
</html>